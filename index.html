<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Data Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library PapaParse untuk membaca CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        
        /* (DIUBAH) CSS Tabel Presisi */
        .col-no { width: 40px; text-align: center; }
        .col-name { width: auto; } /* Sisa ruang untuk nama */
        .col-type { width: 100px; }
        .col-qty { width: 70px; }
        .col-price { width: 130px; }
        .col-bonus { width: 120px; }
        .col-total { width: 140px; text-align: right; }
        
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 8px 6px; vertical-align: middle; font-size: 0.85rem; }
        
        .form-input-sm {
            @apply w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500;
        }
        .form-select-sm {
            @apply w-full px-1 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-2 md:p-6 max-w-7xl">
        <header class="mb-6 bg-white p-6 rounded-lg shadow">
            <h1 class="text-3xl font-bold text-gray-900">Formulir Data Order</h1>
        </header>

        <!-- Bagian Data Pelanggan -->
        <section class="mb-6 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Data Pelanggan</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                    <input type="text" id="customerName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Alamat, PIC, Telp, dll)</label>
                    <textarea id="keterangan" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan alamat kirim, nama PIC, dan no telp..."></textarea>
                </div>
            </div>
        </section>

        <!-- Bagian Detail Pesanan -->
        <section class="mb-6 bg-white p-4 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold">Detail Pesanan</h2>
                <div class="space-x-2">
                    <button id="openPriceListModalBtn" class="text-xs md:text-sm bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded shadow">
                        Ubah List Harga
                    </button>
                </div>
            </div>

            <!-- Tabel dengan Layout Presisi -->
            <div class="overflow-x-auto">
                <table class="min-w-[1000px]">
                    <thead class="bg-gray-100 text-gray-700 text-xs uppercase font-bold border-b border-gray-300">
                        <tr>
                            <th class="col-no">#</th>
                            <th class="col-name text-left pl-2">Nama Barang</th>
                            <th class="col-type text-left">Tipe Harga</th>
                            <th class="col-qty text-center">Qty</th>
                            <th class="col-price text-left">Harga Satuan</th>
                            <th class="col-bonus text-left">Bonus</th>
                            <th class="col-total pr-4">Total</th>
                        </tr>
                    </thead>
                    <tbody id="order-rows-body" class="text-sm divide-y divide-gray-200">
                        <!-- Baris akan di-generate oleh JS -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-blue-50 font-bold border-t-2 border-blue-200">
                            <td colspan="6" class="text-right py-3 pr-4 text-lg text-gray-700">GRAND TOTAL:</td>
                            <td id="grand-total" class="text-right py-3 pr-4 text-lg text-blue-800">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        <!-- Tombol Aksi -->
        <section class="flex justify-end gap-4 bg-white p-6 rounded-lg shadow mb-8 sticky bottom-0 z-10 border-t">
            <input type="hidden" id="edit-log-id" value="">
            
            <button id="cancel-edit-btn" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-md shadow transition">
                Batal Edit
            </button>
            <button id="reset-form" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md shadow transition">
                Reset Form
            </button>
            <button id="submit-order" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md shadow transition transform hover:scale-105">
                Submit / Simpan
            </button>
        </section>

        <!-- Bagian Log Pesanan -->
        <section id="orderLogSection" class="bg-white p-6 rounded-lg shadow hidden">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Log Pesanan</h2>
            <div id="orderLogContent" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                <!-- Log akan di-generate oleh JS -->
            </div>
        </section>
    </div>

    <!-- Modal Ubah List Harga -->
    <div id="priceListModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 modal z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto modal-content transform scale-95">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold">Kelola List Harga (Upload CSV)</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-md">
                    <h4 class="font-bold text-sm">METODE: Upload CSV 3-Kolom</h4>
                    <ul class="list-disc list-inside text-xs pl-2 mt-1">
                        <li>File CSV harus **3 KOLOM SAJA** (A, B, C).</li>
                        <li>Kolom A: Nama Barang | Kolom B: Harga ISP | Kolom C: Harga MSRP</li>
                        <li><strong>JANGAN ADA HEADER</strong> di baris pertama.</li>
                    </ul>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Upload File CSV:</label>
                    <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <span id="fileNameDisplay" class="text-xs text-gray-500 mt-1 block"></span>
                </div>
                <div id="uploadStatus" class="text-sm font-medium hidden"></div>
                <div>
                    <h4 class="text-sm font-semibold mb-2">Preview List Harga:</h4>
                    <div class="border rounded-lg max-h-48 overflow-y-auto bg-gray-50 text-xs">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr><th class="w-1/2 text-left p-2">Nama</th><th class="text-left p-2">ISP</th><th class="text-left p-2">MSRP</th></tr>
                            </thead>
                            <tbody id="priceListTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Preview WhatsApp -->
    <div id="whatsappPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 modal z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold">Preview WhatsApp</h3>
                <button id="closePreviewModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-2">Siap di-copy ke WhatsApp:</p>
                <div id="whatsappPreviewText" class="w-full h-64 p-4 border rounded-md bg-gray-50 overflow-y-auto whitespace-pre-wrap text-sm font-mono text-gray-800"></div>
                <button id="copyToClipboardBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md shadow hover:bg-green-800 transition">
                    Copy Teks
                </button>
                <span id="copySuccessMsg" class="text-green-600 text-sm mt-2 hidden block text-center font-bold">Teks berhasil di-copy!</span>
            </div>
        </div>
    </div>

    <script>
        // Variabel Global untuk Logic Hapus/Edit
        let priceList = [];
        let specialPrices = {};
        let orderLog = [];
        const ORDER_LOG_STORAGE_KEY = 'orderFormData_orderLog';
        const PRICE_LIST_STORAGE_KEY = 'orderFormData_priceList';
        const CUSTOMER_STORAGE_KEY = 'orderFormData_customer';
        const SPECIAL_PRICE_STORAGE_KEY = 'orderFormData_specialPrices';
        const NUM_ROWS = 8;

        // Expose fungsi ke window agar bisa diakses oleh onclick HTML
        window.hapusLog = function(id) {
            if(confirm("Yakin ingin menghapus pesanan ini?")) {
                orderLog = orderLog.filter(log => log.id !== id);
                localStorage.setItem(ORDER_LOG_STORAGE_KEY, JSON.stringify(orderLog));
                renderOrderLog();
            }
        };

        window.editLog = function(id) {
            const logToEdit = orderLog.find(log => log.id === id);
            if (!logToEdit) return;
            
            // Isi Form
            document.getElementById('customerName').value = logToEdit.customerName;
            document.getElementById('keterangan').value = logToEdit.keterangan;
            
            // Reset baris
            // Kita trigger logic update row manual
            const orderRowsBody = document.getElementById('order-rows-body');
            
            // Reset dulu select dan input
            const selects = document.querySelectorAll('.item-select');
            selects.forEach(s => s.value = "");
            
            // Isi item
            logToEdit.items.forEach((item, index) => {
                if (index < NUM_ROWS) {
                    const row = document.getElementById(`row-${index}`);
                    // Cari item di pricelist berdasarkan nama
                    const foundItem = priceList.find(p => p.name === item.name);
                    
                    const itemSelect = row.querySelector('.item-select');
                    const priceTypeSelect = row.querySelector('.price-type-select');
                    const qtyInput = row.querySelector('.qty-input');
                    const priceInput = row.querySelector('.price-input');
                    const bonusInput = row.querySelector('.bonus-input');
                    const totalSpan = row.querySelector('.row-total');

                    if (foundItem) itemSelect.value = foundItem.id;
                    
                    let pTypeVal = 'isp';
                    if (item.priceType && item.priceType.toLowerCase() === 'msrp') pTypeVal = 'msrp';
                    if (item.priceType && item.priceType.toLowerCase() === 'special') pTypeVal = 'special';
                    priceTypeSelect.value = pTypeVal;

                    qtyInput.value = item.qty;
                    priceInput.value = formatCurrency(item.price);
                    bonusInput.value = item.bonus || '';
                    totalSpan.textContent = formatCurrency(item.rowTotal);
                    
                    if (pTypeVal === 'special') priceInput.disabled = false;
                    else priceInput.disabled = true;
                }
            });
            
            // Update Total
            let grandTotal = 0;
            document.querySelectorAll('.row-total').forEach(span => {
                grandTotal += parseCurrency(span.textContent);
            });
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);

            // Set Mode Edit
            document.getElementById('edit-log-id').value = id;
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            const submitBtn = document.getElementById('submit-order');
            submitBtn.textContent = "Update Pesanan";
            submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            alert("Mode Edit Aktif. Silakan ubah data dan klik Update.");
        };

        // Helper Formatting
        function formatCurrency(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num); }
        function parseCurrency(value) { if (typeof value === 'number') return value; const cleaned = String(value).replace(/[^0-9]/g, ''); return parseFloat(cleaned) || 0; }
        function parsePriceString(value) { if (typeof value === 'number') return Math.round(value); if (!value) return 0; const cleaned = String(value).replace(/[^0-9]/g, ''); return parseInt(cleaned, 10) || 0; }

        // Render Log Function (Global Scope needed for initialization but logic inside)
        function renderOrderLog() {
            const orderLogContent = document.getElementById('orderLogContent');
            const orderLogSection = document.getElementById('orderLogSection');
            
            orderLogContent.innerHTML = '';
            if (orderLog.length === 0) { orderLogSection.classList.add('hidden'); return; }
            orderLogSection.classList.remove('hidden');
            
            [...orderLog].reverse().forEach((log) => { 
                const logEntry = document.createElement('div');
                logEntry.classList.add('p-4', 'border', 'border-gray-200', 'rounded-lg', 'bg-gray-50', 'mb-4');
                
                let itemsHtml = log.items.map(item => `
                    <div class="flex justify-between text-sm text-gray-700 border-b border-gray-200 py-1 last:border-0">
                        <span class="font-medium w-1/2 truncate">${item.name}</span>
                        <span class="text-gray-500 w-16 text-center">${item.qty}x</span>
                        <span class="text-gray-500 w-24 text-right">${formatCurrency(item.price)}</span>
                        <span class="font-bold w-24 text-right text-gray-900">${formatCurrency(item.rowTotal)}</span>
                    </div>
                `).join('');
                
                // GUNAKAN ONCLICK LANGSUNG DI SINI (METODE PALING STABIL)
                logEntry.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-bold text-blue-800 text-lg">${log.customerName || 'Tanpa Nama'}</p>
                            <p class="text-xs text-gray-500">${log.timestamp}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="window.editLog(${log.id})" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded font-medium shadow">Edit</button>
                            <button onclick="window.hapusLog(${log.id})" class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded font-medium shadow">Hapus</button>
                        </div>
                    </div>
                    <div class="bg-white p-2 rounded border border-gray-200 mb-2">${itemsHtml}</div>
                    <div class="flex justify-between items-center border-t pt-2 mt-2">
                        <p class="text-xs text-gray-500 italic max-w-xs truncate">${log.keterangan || ''}</p>
                        <p class="text-lg font-bold text-green-700">Total: ${formatCurrency(log.grandTotal)}</p>
                    </div>
                `;
                orderLogContent.appendChild(logEntry);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Data Default
            const defaultPriceList = [
                { id: 'def-p1-1', name: 'PRECON /PATCHORD G657A1 1 Core 500 M', price_isp: 360000, price_msrp: 399600 },
                { id: 'def-p1-2', name: 'PRECON /PATCHORD G657A1 1 Core 300 M', price_isp: 240000, price_msrp: 266400 },
                { id: 'def-p1-3', name: 'PRECON /PATCHORD G657A1 1 Core 250 M', price_isp: 200000, price_msrp: 222000 },
                { id: 'def-p1-4', name: 'PRECON /PATCHORD G657A1 1 Core 200 M', price_isp: 184000, price_msrp: 204240 },
                { id: 'def-p1-5', name: 'PRECON /PATCHORD G657A1 1 Core 150 M', price_isp: 113000, price_msrp: 125430 },
                { id: 'def-p1-6', name: 'PRECON /PATCHORD G657A1 1 Core 100 M', price_isp: 87000, price_msrp: 96570 },
                { id: 'def-p1-7', name: 'PRECON /PATCHORD G657A1 1 Core 80 M', price_isp: 69000, price_msrp: 76590 },
                { id: 'def-p1-8', name: 'PRECON /PATCHORD G657A1 1 Core 50 M', price_isp: 55500, price_msrp: 61605 },
                { id: 'def-p2-1', name: 'PRECON /PATCHORD G657A2 1 Core 500 M', price_isp: 422500, price_msrp: 468975 },
                { id: 'def-p2-2', name: 'PRECON /PATCHORD G657A2 1 Core 300 M', price_isp: 277500, price_msrp: 308025 },
                { id: 'def-p2-3', name: 'PRECON /PATCHORD G657A2 1 Core 250 M', price_isp: 231250, price_msrp: 256688 },
                { id: 'def-p2-4', name: 'PRECON /PATCHORD G657A2 1 Core 200 M', price_isp: 185000, price_msrp: 205350 },
                { id: 'def-p2-5', name: 'PRECON /PATCHORD G657A2 1 Core 150 M', price_isp: 131750, price_msrp: 146243 },
                { id: 'def-p2-6', name: 'PRECON /PATCHORD G657A2 1 Core 100 M', price_isp: 99500, price_msrp: 110445 },
                { id: 'def-p2-7', name: 'PRECON /PATCHORD G657A2 1 Core 80 M', price_isp: 79000, price_msrp: 87690 },
                { id: 'def-p2-8', name: 'PRECON /PATCHORD G657A2 1 Core 50 M', price_isp: 61750, price_msrp: 68543 },
                { id: 'def-f-1', name: 'FIBER OPTIC CABLE ADSS 288 CORE ( 24 TUBE ) 4 KM', price_isp: 150000000, price_msrp: 166500000 },
                { id: 'def-f-2', name: 'FIBER OPTIC CABLE ADSS 144 CORE ( 12 TUBE ) 4 KM', price_isp: 75000000, price_msrp: 83250000 },
                { id: 'def-f-3', name: 'FIBER OPTIC CABLE ADSS 96 CORE ( 8 TUBE ) 4 KM', price_isp: 49900000, price_msrp: 55389000 },
                { id: 'def-f-4', name: 'FIBER OPTIC CABLE ADSS 96 CORE ( 8 TUBE ) 2 KM', price_isp: 25700000, price_msrp: 28527000 },
                { id: 'def-f-5', name: 'FIBER OPTIC CABLE ADSS 48 CORE ( 4 TUBE ) 4 KM', price_isp: 29990000, price_msrp: 33288900 },
                { id: 'def-f-6', name: 'FIBER OPTIC CABLE ADSS 48 CORE ( 4 TUBE ) 2 KM', price_isp: 15745000, price_msrp: 17476950 },
                { id: 'def-f-7', name: 'FIBER OPTIC CABLE ADSS 24 CORE ( 4 TUBE ) 4 KM', price_isp: 20999000, price_msrp: 23308890 },
                { id: 'def-f-8', name: 'FIBER OPTIC CABLE ADSS 24 CORE ( 4 TUBE ) 2 KM', price_isp: 10999000, price_msrp: 12208890 },
                { id: 'def-f-9', name: 'FIBER OPTIC CABLE ADSS 12 CORE ( 2 TUBE ) 4 KM', price_isp: 14900000, price_msrp: 16539000 },
                { id: 'def-f-10', name: 'FIBER OPTIC CABLE ADSS 12 CORE ( 2 TUBE ) 2 KM', price_isp: 7850000, price_msrp: 8713500 },
                { id: 'def-f-11', name: 'FIBER OPTIC CABLE FIG 8 ( 2 SELING ) 12 CORE', price_isp: 4900, price_msrp: 5439 },
                { id: 'def-f-12', name: 'FIBER OPTIC CABLE FIG 8 ( 2 SELING ) 24 CORE', price_isp: 6500, price_msrp: 7215 },
                { id: 'def-f-13', name: 'FIBER OPTIC CABLE FIG 8 ( 2 SELING ) 48 CORE', price_isp: 8900, price_msrp: 9879 },
                { id: 'def-f-14', name: 'FAST CONNECTOR SC/UPC', price_isp: 3500, price_msrp: 3885 },
                { id: 'def-f-15', name: 'PIGTAIL SC/UPC', price_isp: 3500, price_msrp: 3885 },
                { id: 'def-f-16', name: 'PATCHORD SC/UPC 1 METER', price_isp: 11000, price_msrp: 12210 },
                { id: 'def-f-17', name: 'PATCHORD SC/UPC 3 METER', price_isp: 13000, price_msrp: 14430 },
                { id: 'def-f-18', name: 'PATCHORD SC/UPC 5 METER', price_isp: 15000, price_msrp: 16650 },
                { id: 'def-f-19', name: 'PATCHORD SC/UPC 10 METER', price_isp: 18000, price_msrp: 19980 },
                { id: 'def-f-20', name: 'PATCHORD SC/UPC 20 METER', price_isp: 25000, price_msrp: 27750 },
                { id: 'def-f-21', name: 'ADAPTOR SC/UPC', price_isp: 2500, price_msrp: 2775 },
                { id: 'def-f-22', name: 'DOME FIBER OPTIC JOINT CLOSURE 48 CORES', price_isp: 350000, price_msrp: 388500 },
                { id: 'def-f-23', name: 'DOME FIBER OPTIC JOINT CLOSURE 96 CORES', price_isp: 450000, price_msrp: 499500 },
                { id: 'def-f-24', name: 'HORIZONTAL FIBER OPTIC JOINT CLOSURE 12 CORES', price_isp: 135000, price_msrp: 149850 },
                { id: 'def-f-25', name: 'HORIZONTAL FIBER OPTIC JOINT CLOSURE 24 CORES', price_isp: 145000, price_msrp: 160950 },
                { id: 'def-f-26', name: 'Mini PLC splitter 1*16 SC/UPC', price_isp: 93000, price_msrp: 103230 },
                { id: 'def-f-27', name: 'Mini PLC splitter 1*8 SC/UPC', price_isp: 49000, price_msrp: 54390 },
                { id: 'def-f-28', name: 'Mini PLC splitter 1*4 SC/UPC', price_isp: 39000, price_msrp: 43290 },
                { id: 'def-f-29', name: 'OPTIC DISTRIBUTION BOX 8 CORES with 1*8 cassette PLC splitter', price_isp: 125000, price_msrp: 138750 },
                { id: 'def-f-30', name: 'OPTIC DISTRIBUTION BOX 16 CORES with 1*16 cassette PLC splitter', price_isp: 225000, price_msrp: 249750 },
                { id: 'def-f-31', name: 'OPTIC DISTRIBUTION BOX 32 CORES with 1*16 cassette PLC splitter', price_isp: 270000, price_msrp: 299700 },
                { id: 'def-f-32', name: 'OPTICAL DISTRIBUTION FRAME (ODF) 48 CORES...', price_isp: 799000, price_msrp: 886890 },
                { id: 'def-f-33', name: 'OPTICAL DISRIBUTION FRAME (ODF) 96 CORES...', price_isp: 1275000, price_msrp: 1415250 },
                { id: 'def-f-34', name: 'DEAD END 16- 25MM Lengkap beserta Kupingan', price_isp: 16000, price_msrp: 17760 },
                { id: 'def-f-35', name: 'DEAD END 25- 50MM Lengkap beserta Kupingan', price_isp: 17000, price_msrp: 18870 },
                { id: 'def-f-36', name: 'DEAD END STRAIN Plastik Lengkap beserta Kupingan', price_isp: 9900, price_msrp: 10989 },
                { id: 'def-f-37', name: 'PRPRECON /PATCHORD G657A1 2 CORE100M', price_isp: 160000, price_msrp: 177600 },
                { id: 'def-f-38', name: 'PRPRECON /PATCHORD G657A1 2 CORE150M', price_isp: 210000, price_msrp: 233100 },
                { id: 'def-f-39', name: 'PRPRECON /PATCHORD G657A1 2 CORE200M', price_isp: 260000, price_msrp: 288600 },
                { id: 'def-f-40', name: 'PRPRECON /PATCHORD G657A1 2 CORE300M', price_isp: 390000, price_msrp: 432900 },
                { id: 'def-f-41', name: 'PRPRECON /PATCHORD G657A1 2 CORE50M', price_isp: 99000, price_msrp: 109890 },
                { id: 'def-f-42', name: 'PRPRECON /PATCHORD G657A2 2 CORE100M', price_isp: 172500, price_msrp: 191475 },
                { id: 'def-f-43', name: 'PRPRECON /PATCHORD G657A2 2 CORE150M', price_isp: 228750, price_msrp: 253913 },
                { id: 'def-f-44', name: 'PRPRECON /PATCHORD G657A2 2 CORE200M', price_isp: 285000, price_msrp: 316350 },
                { id: 'def-f-45', name: 'PRPRECON /PATCHORD G657A2 2 CORE300M', price_isp: 427500, price_msrp: 474525 },
                { id: 'def-f-46', name: 'PRPRECON /PATCHORD G657A2 2 CORE50M', price_isp: 105250, price_msrp: 116828 },
                { id: 'def-f-47', name: 'SUSPENSION CORONG untuk kabel bulat 1-288 core', price_isp: 16000, price_msrp: 17760 },
                { id: 'def-f-48', name: 'TOTOLINK G1200SE DUAL BAND', price_isp: 350000, price_msrp: 390000 },
                { id: 'def-f-49', name: 'TOTOLINK G300L SINGLE BAND', price_isp: 190000, price_msrp: 225000 }
            ];

            // DOM Elements
            const customerInputs = { name: document.getElementById('customerName'), keterangan: document.getElementById('keterangan') };
            const orderRowsBody = document.getElementById('order-rows-body');
            const grandTotalEl = document.getElementById('grand-total');
            const submitOrderBtn = document.getElementById('submit-order');
            const resetFormBtn = document.getElementById('reset-form');
            const orderLogSection = document.getElementById('orderLogSection');
            const orderLogContent = document.getElementById('orderLogContent');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const editLogIdInput = document.getElementById('edit-log-id');
            
            // Modal Elements
            const modal = document.getElementById('priceListModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const openPriceListModalBtn = document.getElementById('openPriceListModalBtn');
            const csvFileInput = document.getElementById('csvFileInput');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const uploadStatus = document.getElementById('uploadStatus');
            const priceListTableBody = document.getElementById('priceListTableBody');
            
            // WA Preview
            const previewModal = document.getElementById('whatsappPreviewModal');
            const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
            const whatsappPreviewText = document.getElementById('whatsappPreviewText');
            const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
            const copySuccessMsg = document.getElementById('copySuccessMsg');

            // Load Data
            function loadData() {
                const storedPriceList = localStorage.getItem(PRICE_LIST_STORAGE_KEY);
                priceList = (storedPriceList && JSON.parse(storedPriceList).length > 2) ? JSON.parse(storedPriceList) : defaultPriceList;
                priceList.sort((a, b) => a.name.localeCompare(b.name));
                
                specialPrices = JSON.parse(localStorage.getItem(SPECIAL_PRICE_STORAGE_KEY)) || {};
                orderLog = JSON.parse(localStorage.getItem(ORDER_LOG_STORAGE_KEY)) || [];
                
                // Load customer data only if NOT in edit mode
                if (!editLogIdInput.value) {
                    const custData = JSON.parse(localStorage.getItem(CUSTOMER_STORAGE_KEY)) || {};
                    customerInputs.name.value = custData.name || '';
                    customerInputs.keterangan.value = custData.keterangan || '';
                }
            }

            function updateRow(rowId) {
                const row = document.getElementById(`row-${rowId}`);
                const itemSelect = row.querySelector('.item-select');
                const priceTypeSelect = row.querySelector('.price-type-select');
                const qtyInput = row.querySelector('.qty-input');
                const priceInput = row.querySelector('.price-input');
                const totalSpan = row.querySelector('.row-total');

                const selectedItemId = itemSelect.value;
                const priceType = priceTypeSelect.value;
                const qty = parseFloat(qtyInput.value) || 0;
                
                let price = 0;
                
                if (selectedItemId) {
                    const item = priceList.find(p => p.id === selectedItemId);
                    if (item) {
                        if (priceType === 'isp') {
                            price = item.price_isp;
                            priceInput.value = formatCurrency(price);
                            priceInput.disabled = true;
                        } else if (priceType === 'msrp') {
                            price = item.price_msrp;
                            priceInput.value = formatCurrency(price);
                            priceInput.disabled = true;
                        } else { // Special
                            priceInput.disabled = false;
                            // Saat user mengetik, value input adalah sumber kebenaran
                            // Jika input masih format uang, parse dulu
                            let val = parseCurrency(priceInput.value);
                            price = val;
                        }
                    }
                } else {
                    priceInput.value = "";
                    priceInput.disabled = true;
                }
                
                // Recalculate total based on current price input (for Special) or fixed price
                const rowTotal = qty * price;
                totalSpan.textContent = formatCurrency(rowTotal);
                updateGrandTotal();
            }

            function updateGrandTotal() {
                let grandTotal = 0;
                document.querySelectorAll('.row-total').forEach(span => {
                    grandTotal += parseCurrency(span.textContent);
                });
                grandTotalEl.textContent = formatCurrency(grandTotal);
            }

            function createOrderRows() {
                orderRowsBody.innerHTML = '';
                for(let i=0; i<NUM_ROWS; i++) {
                    const tr = document.createElement('tr');
                    tr.id = `row-${i}`;
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="col-no text-center text-gray-500">${i+1}</td>
                        <td class="col-name"><select data-id="${i}" name="item" class="item-select form-select-sm"></select></td>
                        <td class="col-type"><select data-id="${i}" name="priceType" class="price-type-select form-select-sm"><option value="isp">ISP</option><option value="msrp">MSRP</option><option value="special">Special</option></select></td>
                        <td class="col-qty text-center"><input data-id="${i}" name="qty" type="number" min="0" class="qty-input form-input-sm text-center" value=""></td>
                        <td class="col-price"><input data-id="${i}" name="price" type="text" class="price-input form-input-sm text-right" value="" placeholder="0"></td>
                        <td class="col-bonus"><input data-id="${i}" name="bonus" type="text" class="bonus-input form-input-sm" placeholder="-"></td>
                        <td class="col-total"><span class="row-total font-medium block text-right pr-2">Rp 0</span></td>
                    `;
                    orderRowsBody.appendChild(tr);
                }
                updateAllDropdowns();
            }

            function updateAllDropdowns() {
                const optionsHtml = priceList.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                document.querySelectorAll('.item-select').forEach(select => {
                    const val = select.value;
                    select.innerHTML = `<option value="">-- Pilih Barang --</option>${optionsHtml}`;
                    select.value = val;
                });
            }

            // --- Event Listeners ---
            function setupEventListeners() {
                // Row Changes
                orderRowsBody.addEventListener('change', (e) => {
                    if(e.target.matches('.item-select, .price-type-select, .qty-input')) {
                        updateRow(e.target.dataset.id);
                    }
                });
                // Price Input (Manual/Special)
                orderRowsBody.addEventListener('keyup', (e) => {
                    if(e.target.matches('.price-input')) {
                        updateRow(e.target.dataset.id);
                    }
                });
                
                // Submit
                submitOrderBtn.addEventListener('click', handleSubmit);
                
                // Reset / Cancel Edit
                resetFormBtn.addEventListener('click', () => {
                    if(confirm("Reset formulir?")) {
                        if(editLogIdInput.value) cancelEditMode();
                        else {
                            createOrderRows();
                            updateGrandTotal();
                            customerInputs.name.value = '';
                            customerInputs.keterangan.value = '';
                            localStorage.setItem(CUSTOMER_STORAGE_KEY, JSON.stringify({name:'', keterangan:''}));
                        }
                    }
                });
                
                cancelEditBtn.addEventListener('click', cancelEditMode);
                
                // Customer Data Save
                customerInputs.name.addEventListener('blur', () => { if(!editLogIdInput.value) saveCustomerData(); });
                customerInputs.keterangan.addEventListener('blur', () => { if(!editLogIdInput.value) saveCustomerData(); });
                
                // Modal
                openPriceListModalBtn.addEventListener('click', () => {
                    modal.classList.remove('hidden'); setTimeout(() => modal.classList.remove('opacity-0'), 10);
                    renderPriceListTableInModal();
                });
                closeModalBtn.addEventListener('click', () => { modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); });
                csvFileInput.addEventListener('change', handleCsvUpload);
                
                // Preview WA
                closePreviewModalBtn.addEventListener('click', () => { previewModal.classList.add('opacity-0'); setTimeout(() => previewModal.classList.add('hidden'), 300); });
                copyToClipboardBtn.addEventListener('click', () => {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = whatsappPreviewText.innerText;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    copySuccessMsg.classList.remove('hidden');
                    setTimeout(() => copySuccessMsg.classList.add('hidden'), 2000);
                });
            }
            
            function saveCustomerData() {
                const data = { name: customerInputs.name.value, keterangan: customerInputs.keterangan.value };
                localStorage.setItem(CUSTOMER_STORAGE_KEY, JSON.stringify(data));
            }

            function handleSubmit() {
                const now = new Date();
                const timestampStr = now.toLocaleString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(/\./g, '.');
                
                const orderData = {
                    id: editLogIdInput.value ? parseInt(editLogIdInput.value) : Date.now(),
                    customerName: customerInputs.name.value,
                    keterangan: customerInputs.keterangan.value,
                    timestamp: timestampStr,
                    items: [],
                    grandTotal: 0
                };

                let waText = `*ORDER*\n*Tanggal:* ${orderData.timestamp}\n*Customer:* ${orderData.customerName || '-'}\n\n--------------------------------------\n*Detail Pesanan:*\n\n`;
                let hasItems = false;

                for(let i=0; i<NUM_ROWS; i++) {
                    const row = document.getElementById(`row-${i}`);
                    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                    if(qty > 0) {
                        hasItems = true;
                        const itemSelect = row.querySelector('.item-select');
                        const priceTypeSelect = row.querySelector('.price-type-select');
                        const item = priceList.find(p => p.id === itemSelect.value);
                        const price = parseCurrency(row.querySelector('.price-input').value);
                        const bonus = row.querySelector('.bonus-input').value.trim();
                        const rowTotal = qty * price;
                        
                        let pType = priceTypeSelect.options[priceTypeSelect.selectedIndex].text;
                        if(pType.toLowerCase() === 'special') pType = 'Special';

                        const itemData = {
                            name: item ? item.name : 'Unknown',
                            priceType: pType,
                            qty: qty,
                            price: price,
                            bonus: bonus,
                            rowTotal: rowTotal
                        };
                        orderData.items.push(itemData);
                        
                        waText += `*${itemData.name}*\n${itemData.qty} pcs @ ${formatCurrency(itemData.price)} (${itemData.priceType})\n${itemData.bonus ? `Bonus: ${itemData.bonus}\n` : ''}Total: ${formatCurrency(itemData.rowTotal)}\n\n`;
                    }
                }

                if(!hasItems) { alert("Isi minimal satu barang."); return; }

                const grandTotal = parseCurrency(grandTotalEl.textContent);
                orderData.grandTotal = grandTotal;
                waText += `--------------------------------------\n*GRAND TOTAL: ${formatCurrency(grandTotal)}*\n\n*Keterangan:* \n${orderData.keterangan || '-'}\n`;

                if(editLogIdInput.value) {
                    const index = orderLog.findIndex(l => l.id === orderData.id);
                    if(index !== -1) orderLog[index] = orderData;
                    cancelEditMode();
                } else {
                    orderLog.push(orderData);
                    saveCustomerData();
                }
                
                localStorage.setItem(ORDER_LOG_STORAGE_KEY, JSON.stringify(orderLog));
                renderOrderLog();
                
                whatsappPreviewText.innerText = waText;
                previewModal.classList.remove('hidden'); setTimeout(() => previewModal.classList.remove('opacity-0'), 10);
            }

            function cancelEditMode() {
                editLogIdInput.value = '';
                cancelEditBtn.classList.add('hidden');
                submitOrderBtn.textContent = "Submit / Simpan";
                submitOrderBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitOrderBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                createOrderRows(); // Reset form to blank
                updateGrandTotal();
                customerInputs.name.value = '';
                customerInputs.keterangan.value = '';
            }
            
            function handleCsvUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                fileNameDisplay.textContent = `File: ${file.name}`;
                uploadStatus.textContent = 'Memproses...';
                uploadStatus.classList.remove('hidden', 'text-red-600', 'text-green-600');
                
                Papa.parse(file, {
                    header: false, skipEmptyLines: true,
                    complete: (results) => {
                        let newPriceList = [];
                        let count = 0;
                        results.data.forEach(row => {
                            if(row.length >= 3) {
                                const name = String(row[0]).trim();
                                const isp = parsePriceString(row[1]);
                                const msrp = parsePriceString(row[2]);
                                if(name && name.length > 2 && isp > 0 && msrp > 0) {
                                    newPriceList.push({ id: `item-${Date.now()}-${count++}`, name: name, price_isp: isp, price_msrp: msrp });
                                }
                            }
                        });
                        
                        if(newPriceList.length === 0) {
                            uploadStatus.textContent = 'Gagal. Cek format CSV.';
                            uploadStatus.classList.add('text-red-600');
                        } else {
                            priceList = newPriceList;
                            priceList.sort((a, b) => a.name.localeCompare(b.name));
                            localStorage.setItem(PRICE_LIST_STORAGE_KEY, JSON.stringify(priceList));
                            updateAllDropdowns();
                            renderPriceListTableInModal();
                            uploadStatus.textContent = `Sukses! ${newPriceList.length} barang.`;
                            uploadStatus.classList.add('text-green-600');
                        }
                    }
                });
            }
            
            function renderPriceListTableInModal() {
                const tbody = document.getElementById('priceListTableBody');
                tbody.innerHTML = '';
                priceList.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `<td class="p-2">${item.name}</td><td class="p-2">${formatCurrency(item.price_isp)}</td><td class="p-2">${formatCurrency(item.price_msrp)}</td>`;
                    tbody.appendChild(tr);
                });
            }

            // Init
            loadData();
            createOrderRows();
            setupEventListeners();
            updateAllDropdowns();
            renderOrderLog(); // Render log on startup
        });
    </script>
</body>
</html>
