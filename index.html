<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Data Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library PapaParse untuk membaca CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        .table-auto th, .table-auto td {
            padding: 8px 12px;
            text-align: left;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-6 bg-white p-6 rounded-lg shadow">
            <h1 class="text-3xl font-bold text-gray-900">Formulir Data Order</h1>
        </header>

        <!-- Bagian Data Pelanggan -->
        <section class="mb-6 bg-white p-6 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Data Pelanggan</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                    <input type="text" id="customerName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="keterangan" class="block text-sm font-medium text-gray-700 mb-1">Keterangan (Alamat, PIC, Telp, dll)</label>
                    <textarea id="keterangan" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan alamat kirim, nama PIC, dan no telp..."></textarea>
                </div>
            </div>
        </section>

        <!-- Bagian Detail Pesanan -->
        <section class="mb-6 bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-semibold">Detail Pesanan</h2>
                <button id="openPriceListModalBtn" class="text-sm bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Ubah List Harga
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-1/3">Nama Barang</th>
                            <th class="w-24">Tipe Harga</th>
                            <th class="w-24">Qty</th>
                            <th class="w-40">Harga Satuan</th>
                            <th class="w-32">Bonus/Ket.</th>
                            <th class="w-40">Total</th>
                        </tr>
                    </thead>
                    <tbody id="order-rows-body">
                        <!-- Baris akan di-generate oleh JS -->
                    </tbody>
                    <tfoot>
                        <tr class="border-t-2 font-bold">
                            <td colspan="5" class="text-right text-lg pr-4">Grand Total:</td>
                            <td id="grand-total" class="text-lg">Rp 0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        <!-- Tombol Aksi -->
        <section class="flex justify-end gap-4 bg-white p-6 rounded-lg shadow">
            <button id="reset-form" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Reset
            </button>
            <button id="submit-order" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                Submit
            </button>
        </section>

        <!-- Bagian Log Pesanan -->
        <section id="orderLogSection" class="mt-8 bg-white p-6 rounded-lg shadow hidden">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">Log Pesanan</h2>
            <div id="orderLogContent" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Log akan di-generate oleh JS -->
            </div>
        </section>
    </div>

    <!-- Modal Ubah List Harga -->
    <div id="priceListModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 modal z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto modal-content transform scale-95">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold">Kelola List Harga (Upload CSV)</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-md">
                    <h4 class="font-bold">METODE BARU (Paling Stabil):</h4>
                    <p class="text-sm">Jika ada perubahan harga, siapkan **SATU FILE CSV** yang berisi **SEMUA** barang Anda.</p>
                    <ul class="list-disc list-inside text-sm pl-2 mt-2">
                        <li>File CSV harus **3 KOLOM SAJA** (A, B, C).</li>
                        <li><strong>Kolom A:</strong> Nama Barang (Lengkap)</li>
                        <li><strong>Kolom B:</strong> Harga ISP (Angkanya saja, misal `150000`)</li>
                        <li><strong>Kolom C:</strong> Harga MSRP (Angkanya saja, misal `165000`)</li>
                        <li class="font-bold">Pastikan **TIDAK ADA** header/judul di baris pertama.</li>
                        <li>Pastikan **TIDAK ADA** baris kosong.</li>
                    </ul>
                </div>

                <div>
                    <label for="csvFileInput" class="block text-sm font-medium text-gray-700 mb-1">Upload File CSV (Format 3-Kolom):</label>
                    <input type="file" id="csvFileInput" accept=".csv" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:font-semibold file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100
                    ">
                    <span id="fileNameDisplay" class="text-sm text-gray-600 mt-1 block"></span>
                </div>

                <div id="uploadStatus" class="text-sm text-green-600 font-medium hidden"></div>

                <div>
                    <h4 class="text-md font-semibold mb-2">List Harga Saat Ini:</h4>
                    <div class="border rounded-lg max-h-60 overflow-y-auto bg-gray-50">
                        <table class="w-full table-auto">
                            <thead class="bg-gray-200 sticky top-0">
                                <tr>
                                    <th class="w-1/2">Nama Barang</th>
                                    <th>Harga ISP</th>
                                    <th>Harga MSRP</th>
                                </tr>
                            </thead>
                            <tbody id="priceListTableBody">
                                <!-- Data list harga akan di-generate oleh JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Preview WhatsApp -->
    <div id="whatsappPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 modal z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg modal-content transform scale-95">
            <div class="flex justify-between items-center p-5 border-b">
                <h3 class="text-xl font-semibold">Preview WhatsApp</h3>
                <button id="closePreviewModalBtn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-2">Teks berikut siap untuk di-copy dan paste ke WhatsApp:</p>
                <div id="whatsappPreviewText" class="w-full h-64 p-4 border rounded-md bg-gray-50 overflow-y-auto whitespace-pre-wrap text-sm">
                    <!-- Konten WA akan di-generate oleh JS -->
                </div>
                <button id="copyToClipboardBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Copy Teks
                </button>
                <span id="copySuccessMsg" class="text-green-600 text-sm mt-2 hidden">Teks berhasil di-copy!</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const CUSTOMER_STORAGE_KEY = 'orderFormData_customer';
            const PRICE_LIST_STORAGE_KEY = 'orderFormData_priceList';
            const SPECIAL_PRICE_STORAGE_KEY = 'orderFormData_specialPrices';
            const ORDER_LOG_STORAGE_KEY = 'orderFormData_orderLog';
            const NUM_ROWS = 8;

            const defaultPriceList = [
                { id: 'def-p1-1', name: 'PRECON /PATCHORD G657A1 1 Core 500 M', price_isp: 360000, price_msrp: 399600 },
                { id: 'def-p1-2', name: 'PRECON /PATCHORD G657A1 1 Core 300 M', price_isp: 240000, price_msrp: 266400 },
                { id: 'def-p1-3', name: 'PRECON /PATCHORD G657A1 1 Core 250 M', price_isp: 200000, price_msrp: 222000 },
                { id: 'def-p1-4', name: 'PRECON /PATCHORD G657A1 1 Core 200 M', price_isp: 184000, price_msrp: 204240 },
                { id: 'def-p1-5', name: 'PRECON /PATCHORD G657A1 1 Core 150 M', price_isp: 113000, price_msrp: 125430 },
                { id: 'def-p1-6', name: 'PRECON /PATCHORD G657A1 1 Core 100 M', price_isp: 87000, price_msrp: 96570 },
                { id: 'def-p1-7', name: 'PRECON /PATCHORD G657A1 1 Core 80 M', price_isp: 69000, price_msrp: 76590 },
                { id: 'def-p1-8', name: 'PRECON /PATCHORD G657A1 1 Core 50 M', price_isp: 55500, price_msrp: 61605 },
                { id: 'def-p2-1', name: 'PRECON /PATCHORD G657A2 1 Core 500 M', price_isp: 422500, price_msrp: 468975 },
                { id: 'def-p2-2', name: 'PRECON /PATCHORD G657A2 1 Core 300 M', price_isp: 277500, price_msrp: 308025 },
                { id: 'def-p2-3', name: 'PRECON /PATCHORD G657A2 1 Core 250 M', price_isp: 231250, price_msrp: 256688 },
                { id: 'def-p2-4', name: 'PRECON /PATCHORD G657A2 1 Core 200 M', price_isp: 185000, price_msrp: 205350 },
                { id: 'def-p2-5', name: 'PRECON /PATCHORD G657A2 1 Core 150 M', price_isp: 131750, price_msrp: 146243 },
                { id: 'def-p2-6', name: 'PRECON /PATCHORD G657A2 1 Core 100 M', price_isp: 99500, price_msrp: 110445 },
                { id: 'def-p2-7', name: 'PRECON /PATCHORD G657A2 1 Core 80 M', price_isp: 79000, price_msrp: 87690 },
                { id: 'def-p2-8', name: 'PRECON /PATCHORD G657A2 1 Core 50 M', price_isp: 61750, price_msrp: 68543 },
                { id: 'def-f-1', name: 'FIBER OPTIC CABLE ADSS 288 CORE ( 24 TUBE ) 4 KM', price_isp: 150000000, price_msrp: 166500000 },
                { id: 'def-f-2', name: 'FIBER OPTIC CABLE ADSS 144 CORE ( 12 TUBE ) 4 KM', price_isp: 75000000, price_msrp: 83250000 },
                { id: 'def-f-3', name: 'FIBER OPTIC CABLE ADSS 96 CORE ( 8 TUBE ) 4 KM', price_isp: 49900000, price_msrp: 55389000 },
                { id: 'def-f-4', name: 'FIBER OPTIC CABLE ADSS 96 CORE ( 8 TUBE ) 2 KM', price_isp: 25700000, price_msrp: 28527000 },
                { id: 'def-f-5', name: 'FIBER OPTIC CABLE ADSS 48 CORE ( 4 TUBE ) 4 KM', price_isp: 29990000, price_msrp: 33288900 },
                { id: 'def-f-6', name: 'FIBER OPTIC CABLE ADSS 48 CORE ( 4 TUBE ) 2 KM', price_isp: 15745000, price_msrp: 17476950 },
                { id: 'def-f-7', name: 'FIBER OPTIC CABLE ADSS 24 CORE ( 4 TUBE ) 4 KM', price_isp: 20999000, price_msrp: 23308890 },
                { id: 'def-f-8', name: 'FIBER OPTIC CABLE ADSS 24 CORE ( 4 TUBE ) 2 KM', price_isp: 10999000, price_msrp: 12208890 },
                { id: 'def-f-9', name: 'FIBER OPTIC CABLE ADSS 12 CORE ( 2 TUBE ) 4 KM', price_isp: 14900000, price_msrp: 16539000 },
                { id: 'def-f-10', name: 'FIBER OPTIC CABLE ADSS 12 CORE ( 2 TUBE ) 2 KM', price_isp: 7850000, price_msrp: 8713500 },
                { id: 'def-f-11', name: 'FIBER OPTIC CABLE FIG 8 ( 2 SELING ) 12 CORE', price_isp: 4900, price_msrp: 5439 },
                { id: 'def-f-12', name: 'FIBER OPTIC CABLE FIG 8 ( 2 SELING ) 24 CORE', price_isp: 6500, price_msrp: 7215 },
                { id: 'def-f-13', name: 'FIBER OPTIC CABLE FIG 8 ( 2 SELING ) 48 CORE', price_isp: 8900, price_msrp: 9879 },
                { id: 'def-f-14', name: 'FAST CONNECTOR SC/UPC', price_isp: 3500, price_msrp: 3885 },
                { id: 'def-f-15', name: 'PIGTAIL SC/UPC', price_isp: 3500, price_msrp: 3885 },
                { id: 'def-f-16', name: 'PATCHORD SC/UPC 1 METER', price_isp: 11000, price_msrp: 12210 },
                { id: 'def-f-17', name: 'PATCHORD SC/UPC 3 METER', price_isp: 13000, price_msrp: 14430 },
                { id: 'def-f-18', name: 'PATCHORD SC/UPC 5 METER', price_isp: 15000, price_msrp: 16650 },
                { id: 'def-f-19', name: 'PATCHORD SC/UPC 10 METER', price_isp: 18000, price_msrp: 19980 },
                { id: 'def-f-20', name: 'PATCHORD SC/UPC 20 METER', price_isp: 25000, price_msrp: 27750 },
                { id: 'def-f-21', name: 'ADAPTOR SC/UPC', price_isp: 2500, price_msrp: 2775 },
                { id: 'def-f-22', name: 'DOME FIBER OPTIC JOINT CLOSURE 48 CORES', price_isp: 350000, price_msrp: 388500 },
                { id: 'def-f-23', name: 'DOME FIBER OPTIC JOINT CLOSURE 96 CORES', price_isp: 450000, price_msrp: 499500 },
                { id: 'def-f-24', name: 'HORIZONTAL FIBER OPTIC JOINT CLOSURE 12 CORES', price_isp: 135000, price_msrp: 149850 },
                { id: 'def-f-25', name: 'HORIZONTAL FIBER OPTIC JOINT CLOSURE 24 CORES', price_isp: 145000, price_msrp: 160950 },
                { id: 'def-f-26', name: 'Mini PLC splitter 1*16 SC/UPC', price_isp: 93000, price_msrp: 103230 },
                { id: 'def-f-27', name: 'Mini PLC splitter 1*8 SC/UPC', price_isp: 49000, price_msrp: 54390 },
                { id: 'def-f-28', name: 'Mini PLC splitter 1*4 SC/UPC', price_isp: 39000, price_msrp: 43290 },
                { id: 'def-f-29', name: 'OPTIC DISTRIBUTION BOX 8 CORES with 1*8 cassette PLC splitter', price_isp: 125000, price_msrp: 138750 },
                { id: 'def-f-30', name: 'OPTIC DISTRIBUTION BOX 16 CORES with 1*16 cassette PLC splitter', price_isp: 225000, price_msrp: 249750 },
                { id: 'def-f-31', name: 'OPTIC DISTRIBUTION BOX 32 CORES with 1*16 cassette PLC splitter', price_isp: 270000, price_msrp: 299700 },
                { id: 'def-f-32', name: 'OPTICAL DISTRIBUTION FRAME (ODF) 48 CORES...', price_isp: 799000, price_msrp: 886890 },
                { id: 'def-f-33', name: 'OPTICAL DISRIBUTION FRAME (ODF) 96 CORES...', price_isp: 1275000, price_msrp: 1415250 },
                { id: 'def-f-34', name: 'DEAD END 16- 25MM Lengkap beserta Kupingan', price_isp: 16000, price_msrp: 17760 },
                { id: 'def-f-35', name: 'DEAD END 25- 50MM Lengkap beserta Kupingan', price_isp: 17000, price_msrp: 18870 },
                { id: 'def-f-36', name: 'DEAD END STRAIN Plastik Lengkap beserta Kupingan', price_isp: 9900, price_msrp: 10989 },
                { id: 'def-f-37', name: 'PRPRECON /PATCHORD G657A1 2 CORE100M', price_isp: 160000, price_msrp: 177600 },
                { id: 'def-f-38', name: 'PRPRECON /PATCHORD G657A1 2 CORE150M', price_isp: 210000, price_msrp: 233100 },
                { id: 'def-f-39', name: 'PRPRECON /PATCHORD G657A1 2 CORE200M', price_isp: 260000, price_msrp: 288600 },
                { id: 'def-f-40', name: 'PRPRECON /PATCHORD G657A1 2 CORE300M', price_isp: 390000, price_msrp: 432900 },
                { id: 'def-f-41', name: 'PRPRECON /PATCHORD G657A1 2 CORE50M', price_isp: 99000, price_msrp: 109890 },
                { id: 'def-f-42', name: 'PRPRECON /PATCHORD G657A2 2 CORE100M', price_isp: 172500, price_msrp: 191475 },
                { id: 'def-f-43', name: 'PRPRECON /PATCHORD G657A2 2 CORE150M', price_isp: 228750, price_msrp: 253913 },
                { id: 'def-f-44', name: 'PRPRECON /PATCHORD G657A2 2 CORE200M', price_isp: 285000, price_msrp: 316350 },
                { id: 'def-f-45', name: 'PRPRECON /PATCHORD G657A2 2 CORE300M', price_isp: 427500, price_msrp: 474525 },
                { id: 'def-f-46', name: 'PRPRECON /PATCHORD G657A2 2 CORE50M', price_isp: 105250, price_msrp: 116828 },
                { id: 'def-f-47', name: 'SUSPENSION CORONG untuk kabel bulat 1-288 core', price_isp: 16000, price_msrp: 17760 },
                { id: 'def-f-48', name: 'TOTOLINK G1200SE DUAL BAND', price_isp: 350000, price_msrp: 390000 },
                { id: 'def-f-49', name: 'TOTOLINK G300L SINGLE BAND', price_isp: 190000, price_msrp: 225000 }
            ];

            let priceList = [];
            let specialPrices = {};
            let orderLog = [];

            const customerInputs = {
                name: document.getElementById('customerName'),
                keterangan: document.getElementById('keterangan')
            };
            
            const modal = document.getElementById('priceListModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const openPriceListModalBtn = document.getElementById('openPriceListModalBtn');
            const csvFileInput = document.getElementById('csvFileInput');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const uploadStatus = document.getElementById('uploadStatus');
            const priceListTableBody = document.getElementById('priceListTableBody');
            
            const previewModal = document.getElementById('whatsappPreviewModal');
            const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
            const whatsappPreviewText = document.getElementById('whatsappPreviewText');
            const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
            const copySuccessMsg = document.getElementById('copySuccessMsg');

            const orderRowsBody = document.getElementById('order-rows-body');
            const grandTotalEl = document.getElementById('grand-total');
            const submitOrderBtn = document.getElementById('submit-order');
            const resetFormBtn = document.getElementById('reset-form');

            const orderLogSection = document.getElementById('orderLogSection');
            const orderLogContent = document.getElementById('orderLogContent');

            function formatCurrency(num) {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
            }

            function parseCurrency(value) {
                if (typeof value === 'number') return value;
                const cleaned = String(value).replace(/[^0-9]/g, '');
                return parseFloat(cleaned) || 0;
            }
            
            function parsePriceString(value) {
                if (typeof value === 'number') {
                    return Math.round(value); 
                }
                if (!value) return 0;
                const cleaned = String(value).replace(/[^0-9]/g, '');
                return parseInt(cleaned, 10) || 0;
            }

            function initialize() {
                loadPriceList();
                loadCustomerData();
                loadSpecialPrices();
                loadOrderLog();
                createOrderRows();
                setupEventListeners();
                updateAllDropdowns();
                renderPriceListTable();
                renderOrderLog();
            }

            function loadPriceList() {
                const storedList = localStorage.getItem(PRICE_LIST_STORAGE_KEY);
                if (storedList && storedList.length > 2) { 
                    priceList = JSON.parse(storedList);
                } else { 
                    priceList = defaultPriceList;
                }
                priceList.sort((a, b) => a.name.localeCompare(b.name));
            }

            function savePriceList() {
                localStorage.setItem(PRICE_LIST_STORAGE_KEY, JSON.stringify(priceList));
                updateAllDropdowns();
                renderPriceListTable();
            }

            function loadCustomerData() {
                const data = JSON.parse(localStorage.getItem(CUSTOMER_STORAGE_KEY)) || {};
                customerInputs.name.value = data.name || '';
                customerInputs.keterangan.value = data.keterangan || '';
            }

            function saveCustomerData() {
                const data = {
                    name: customerInputs.name.value,
                    keterangan: customerInputs.keterangan.value
                };
                localStorage.setItem(CUSTOMER_STORAGE_KEY, JSON.stringify(data));
            }
            
            function loadSpecialPrices() {
                specialPrices = JSON.parse(localStorage.getItem(SPECIAL_PRICE_STORAGE_KEY)) || {};
            }

            function saveSpecialPrices() {
                localStorage.setItem(SPECIAL_PRICE_STORAGE_KEY, JSON.stringify(specialPrices));
            }
            
            function loadOrderLog() {
                orderLog = JSON.parse(localStorage.getItem(ORDER_LOG_STORAGE_KEY)) || [];
            }
            
            function saveOrderLog() {
                localStorage.setItem(ORDER_LOG_STORAGE_KEY, JSON.stringify(orderLog));
            }

            function createOrderRows() {
                orderRowsBody.innerHTML = ''; 
                for (let i = 0; i < NUM_ROWS; i++) {
                    const tr = document.createElement('tr');
                    tr.id = `row-${i}`;
                    tr.classList.add('border-b');
                    tr.innerHTML = `
                        <td class="py-2"><select data-id="${i}" name="item" class="item-select w-full p-2 border border-gray-300 rounded-md"></select></td>
                        <td class="py-2"><select data-id="${i}" name="priceType" class="price-type-select w-full p-2 border border-gray-300 rounded-md">
                            <option value="isp">ISP</option>
                            <option value="msrp">MSRP</option>
                            <option value="special">Special</option>
                        </select></td>
                        <td class="py-2"><input data-id="${i}" name="qty" type="number" min="0" class="qty-input w-20 p-2 border border-gray-300 rounded-md" value="0"></td>
                        <td class="py-2"><input data-id="${i}" name="price" type="text" class="price-input w-full p-2 border border-gray-300 rounded-md" value="0" placeholder="0"></td>
                        <td class="py-2"><input data-id="${i}" name="bonus" type="text" class="bonus-input w-full p-2 border border-gray-300 rounded-md"></td>
                        <td class="py-2"><span class="row-total font-medium">Rp 0</span></td>
                    `;
                    orderRowsBody.appendChild(tr);
                }
            }

            function updateAllDropdowns() {
                const itemSelects = document.querySelectorAll('.item-select');
                const optionsHtml = priceList.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                
                itemSelects.forEach(select => {
                    const currentVal = select.value;
                    select.innerHTML = `<option value="">-- Pilih Barang --</option>${optionsHtml}`;
                    select.value = currentVal; 
                });
            }

            function renderPriceListTable() {
                if (!priceListTableBody) return;
                priceListTableBody.innerHTML = ''; 
                
                if (priceList.length === 0) {
                    priceListTableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">List harga masih kosong.</td></tr>';
                    return;
                }
                
                priceList.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.classList.add('border-b');
                    tr.innerHTML = `
                        <td class="w-1/2">${item.name}</td>
                        <td>${formatCurrency(item.price_isp)}</td>
                        <td>${formatCurrency(item.price_msrp)}</td>
                    `;
                    priceListTableBody.appendChild(tr);
                });
            }
            
            function renderOrderLog() {
                orderLogContent.innerHTML = '';
                if (orderLog.length === 0) {
                    orderLogSection.classList.add('hidden');
                    return;
                }
                
                orderLogSection.classList.remove('hidden');
                orderLog.slice().reverse().forEach((log, index) => { 
                    const logEntry = document.createElement('div');
                    logEntry.classList.add('p-4', 'border', 'rounded-md', 'bg-gray-50');
                    
                    let itemsHtml = log.items.map(item => `
                        <li class="text-sm">${item.qty}x ${item.name} @ ${formatCurrency(item.price)} (${item.priceType})${item.bonus ? ` - ${item.bonus}` : ''} = <strong>${formatCurrency(item.rowTotal)}</strong></li>
                    `).join('');
                    
                    logEntry.innerHTML = `
                        <p class="font-semibold text-gray-800">${log.customerName || 'Tanpa Nama'} - ${log.timestamp}</p>
                        <p class="text-sm text-gray-600 whitespace-pre-wrap mt-1 mb-2">${log.keterangan || 'Tanpa keterangan'}</p>
                        <ul class="list-disc list-inside space-y-1 mb-2">${itemsHtml}</ul>
                        <p class="text-right font-bold text-md text-gray-900">Grand Total: ${formatCurrency(log.grandTotal)}</p>
                    `;
                    orderLogContent.appendChild(logEntry);
                });
            }

            function updateRow(rowId) {
                const itemSelect = document.querySelector(`#row-${rowId} .item-select`);
                const priceTypeSelect = document.querySelector(`#row-${rowId} .price-type-select`);
                const qtyInput = document.querySelector(`#row-${rowId} .qty-input`);
                const priceInput = document.querySelector(`#row-${rowId} .price-input`);
                const totalSpan = document.querySelector(`#row-${rowId} .row-total`);

                const selectedItemId = itemSelect.value;
                const priceType = priceTypeSelect.value;
                const qty = parseFloat(qtyInput.value) || 0;
                
                let price = 0;
                
                if (selectedItemId) {
                    const item = priceList.find(p => p.id === selectedItemId);
                    if (item) {
                        if (priceType === 'isp') {
                            price = item.price_isp;
                            priceInput.value = formatCurrency(price);
                            priceInput.disabled = true;
                        } else if (priceType === 'msrp') {
                            price = item.price_msrp;
                            priceInput.value = formatCurrency(price);
                            priceInput.disabled = true;
                        } else { 
                            priceInput.disabled = false;
                            const specialPrice = specialPrices[selectedItemId];
                            if (specialPrice) {
                                priceInput.value = formatCurrency(specialPrice);
                                price = specialPrice;
                            } else {
                                price = parseCurrency(priceInput.value);
                            }
                        }
                    }
                } else {
                    priceInput.value = "0";
                    priceInput.disabled = true;
                }

                if (priceType === 'special') {
                    price = parseCurrency(priceInput.value);
                }

                const rowTotal = qty * price;
                totalSpan.textContent = formatCurrency(rowTotal);
                
                updateGrandTotal();
            }

            function updateGrandTotal() {
                let grandTotal = 0;
                document.querySelectorAll('.row-total').forEach(span => {
                    grandTotal += parseCurrency(span.textContent);
                });
                grandTotalEl.textContent = formatCurrency(grandTotal);
            }
            
            function resetForm() {
                createOrderRows();
                updateAllDropdowns();
                updateGrandTotal();
                customerInputs.name.value = '';
                customerInputs.keterangan.value = '';
                saveCustomerData();
            }

            function setupEventListeners() {
                customerInputs.name.addEventListener('blur', saveCustomerData);
                customerInputs.keterangan.addEventListener('blur', saveCustomerData);

                orderRowsBody.addEventListener('change', (e) => {
                    if (e.target.classList.contains('item-select') || 
                        e.target.classList.contains('price-type-select') ||
                        e.target.classList.contains('qty-input')) {
                        updateRow(e.target.dataset.id);
                    }
                });
                
                orderRowsBody.addEventListener('input', (e) => {
                     if (e.target.classList.contains('price-input')) {
                        const rowId = e.target.dataset.id;
                        const itemSelect = document.querySelector(`#row-${rowId} .item-select`);
                        const selectedItemId = itemSelect.value;
                        const priceType = document.querySelector(`#row-${rowId} .price-type-select`).value;
                        
                        if (priceType === 'special' && selectedItemId) {
                            const price = parseCurrency(e.target.value);
                            specialPrices[selectedItemId] = price;
                            saveSpecialPrices();
                        }
                        updateRow(rowId);
                    }
                });

                resetFormBtn.addEventListener('click', () => {
                    if (confirm("Apakah Anda yakin ingin mereset seluruh formulir?")) {
                        resetForm();
                    }
                });
                submitOrderBtn.addEventListener('click', handleSubmit);

                setupModalListeners();
                setupPreviewModalListeners();
            }
            
            // (DIUBAH) Handle Submit - FORMAT BARU: Tanggal & Format Item
            function handleSubmit() {
                // Format Tanggal: "19 Nov 2025, 10.29"
                const now = new Date();
                const options = { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                const timestampStr = now.toLocaleString('id-ID', options).replace(/\./g, '.');

                const orderData = {
                    customerName: customerInputs.name.value,
                    keterangan: customerInputs.keterangan.value,
                    timestamp: timestampStr,
                    items: [],
                    grandTotal: 0
                };
                
                // Header
                let waText = `*ORDER*\n`;
                waText += `*Tanggal:* ${orderData.timestamp}\n`;
                waText += `*Customer:* ${orderData.customerName || '-'}\n`;
                
                waText += "\n--------------------------------------\n";
                waText += "*Detail Pesanan:*\n\n";

                let hasItems = false;
                for (let i = 0; i < NUM_ROWS; i++) {
                    const row = document.getElementById(`row-${i}`);
                    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                    
                    if (qty > 0) {
                        hasItems = true;
                        const itemSelect = row.querySelector('.item-select');
                        const priceTypeSelect = row.querySelector('.price-type-select');
                        
                        const itemId = itemSelect.value;
                        const item = priceList.find(p => p.id === itemId);
                        const price = parseCurrency(row.querySelector('.price-input').value);
                        const bonus = row.querySelector('.bonus-input').value.trim();
                        const rowTotal = qty * price;
                        
                        // Format Price Type Title Case (Special, ISP, MSRP)
                        let pType = priceTypeSelect.options[priceTypeSelect.selectedIndex].text;
                        if (pType.toLowerCase() === 'special') pType = 'Special';

                        const itemData = {
                            name: item ? item.name : 'Barang Tidak Dikenal',
                            priceType: pType,
                            qty: qty,
                            price: price,
                            bonus: bonus,
                            rowTotal: rowTotal
                        };
                        orderData.items.push(itemData);
                        
                        // (DIUBAH) Format Item Persis Sesuai Permintaan
                        waText += `*${itemData.name}*\n`; 
                        waText += `${itemData.qty} pcs @ ${formatCurrency(itemData.price)} (${itemData.priceType})\n`;
                        if (itemData.bonus) {
                            waText += `Bonus/Ket: ${itemData.bonus}\n`;
                        }
                        waText += `Total: ${formatCurrency(itemData.rowTotal)}\n`;
                        waText += `\n`; 
                    }
                }
                
                if (!hasItems) {
                    alert("Order gagal. Belum ada barang yang dimasukkan (Qty masih 0).");
                    return;
                }
                
                const grandTotal = parseCurrency(grandTotalEl.textContent);
                orderData.grandTotal = grandTotal;
                
                waText += "--------------------------------------\n";
                waText += `*GRAND TOTAL: ${formatCurrency(grandTotal)}*\n\n`;
                
                // Keterangan di Paling Bawah
                waText += `*Keterangan:* \n${orderData.keterangan || '-'}\n`;

                orderLog.push(orderData);
                saveOrderLog();
                renderOrderLog();
                
                showPreviewModal(waText);
            }

            function setupModalListeners() {
                openPriceListModalBtn.addEventListener('click', () => {
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                });
                
                closeModalBtn.addEventListener('click', closeModal);
                
                csvFileInput.addEventListener('change', handleCsvUpload);
            }
            
            function closeModal() {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
            
            function handleCsvUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                fileNameDisplay.textContent = `File: ${file.name}`;
                uploadStatus.textContent = 'Memproses file...';
                uploadStatus.classList.remove('hidden', 'text-red-600', 'text-green-600');
                uploadStatus.classList.add('text-blue-600');
                priceListTableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Memproses...</td></tr>';

                Papa.parse(file, {
                    header: false, 
                    skipEmptyLines: true,
                    complete: (results) => {
                        let newPriceList = [];
                        let processedCount = 0;

                        results.data.forEach((row) => {
                            if (row.length >= 3) {
                                const name = String(row[0] || '').trim();
                                const isp = parsePriceString(row[1]);
                                const msrp = parsePriceString(row[2]);

                                if (name && name.length > 2 && isp > 0 && msrp > 0) {
                                    newPriceList.push({
                                        id: `item-${Date.now()}-${processedCount++}`,
                                        name: name,
                                        price_isp: isp,
                                        price_msrp: msrp
                                    });
                                }
                            }
                        });

                        if (newPriceList.length === 0) {
                            uploadStatus.textContent = 'Upload Gagal. Tidak ada data valid (format 3-kolom) yang ditemukan.';
                            uploadStatus.classList.remove('text-blue-600');
                            uploadStatus.classList.add('text-red-600');
                            renderPriceListTable(); 
                        } else {
                            priceList = newPriceList; 
                            priceList.sort((a, b) => a.name.localeCompare(b.name));
                            savePriceList();
                            
                            uploadStatus.textContent = `Upload Berhasil! ${newPriceList.length} barang berhasil ditambahkan.`;
                            uploadStatus.classList.remove('text-blue-600');
                            uploadStatus.classList.add('text-green-600');
                        }
                    },
                    error: (err) => {
                        uploadStatus.textContent = `Error: ${err.message}`;
                        uploadStatus.classList.remove('text-blue-600');
                        uploadStatus.classList.add('text-red-600');
                        renderPriceListTable(); 
                    }
                });
            }

            function setupPreviewModalListeners() {
                closePreviewModalBtn.addEventListener('click', () => {
                    previewModal.classList.add('opacity-0');
                    setTimeout(() => previewModal.classList.add('hidden'), 300);
                });
                
                copyToClipboardBtn.addEventListener('click', () => {
                    const textToCopy = whatsappPreviewText.innerText;
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = textToCopy;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    try {
                        document.execCommand('copy');
                        copySuccessMsg.classList.remove('hidden');
                        setTimeout(() => copySuccessMsg.classList.add('hidden'), 2000);
                    } catch (err) {
                        console.error('Gagal copy: ', err);
                        alert('Gagal menyalin teks.');
                    }
                    document.body.removeChild(tempTextArea);
                });
            }
            
            function showPreviewModal(text) {
                whatsappPreviewText.innerText = text;
                previewModal.classList.remove('hidden');
                setTimeout(() => previewModal.classList.remove('opacity-0'), 10);
            }

            initialize();
        });
    </script>
</body>
</html>
